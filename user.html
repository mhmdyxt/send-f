<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f7f9;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            background: #4CAF50;
            color: white;
            width: 100%;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .link-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        #clientLink a {
            color: #4CAF50;
            font-weight: bold;
            word-break: break-all;
            text-decoration: none;
        }
        #gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }
        .media-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }
        .media-container {
            height: 180px;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .media-item img,
        .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .media-footer {
            padding: 12px;
        }
        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .download-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
        }
        .delete-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .no-files {
            grid-column: 1/-1;
            text-align: center;
            color: #888;
        }

        /* Modal & Toast Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-width: 300px;
            width: 90%;
        }
        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 8px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .confirm-del-btn { background: #e74c3c; color: white; }
        .cancel-del-btn { background: #ccc; color: #333; }

        #toast {
            position: fixed;
            bottom: 20px;
            background: #333;
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            display: none;
            z-index: 2000;
            animation: fadeInUp 0.4s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="header">
    <h2 id="dashTitle">My Dashboard</h2>
</div>

<div class="link-box">
    <button id="generateLinkBtn" style="padding:10px 20px; background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">Generate My Link</button>
    <p id="clientLink" style="margin-top: 15px;"></p>
</div>

<div id="gallery">
    <div class="no-files">Connecting to server...</div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
        <h3 style="margin-top:0;">Delete Permanently?</h3>
        <p>This will remove the file from the gallery and the database.</p>
        <div class="modal-btns">
            <button class="modal-btn cancel-del-btn" id="modalCancel">Cancel</button>
            <button class="modal-btn confirm-del-btn" id="modalConfirm">Delete</button>
        </div>
    </div>
</div>

<div id="toast">Action successful!</div>

<script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";
    import { doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

    const socket = io("https://send-b-production.up.railway.app");
    let currentCode = null;

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.innerText = msg;
        toast.style.display = "block";
        setTimeout(() => { toast.style.display = "none"; }, 3000);
    }

    onAuthStateChanged(auth, async (user) => {
        if (!user) return location.href="index.html";

        const snap = await getDoc(doc(db,"users",user.uid));
        const userData = snap.data();

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØªÙ… Ù…Ø±Ø§Ù‚Ø¨ØªÙ‡ Ø­Ø§Ù„ÙŠØ§Ù‹
        currentCode = userData.role === "admin"
            ? (localStorage.getItem("viewingCode") || "1")
            : userData.brandCode;

        document.getElementById("dashTitle").innerText = `Dashboard - Brand ${currentCode}`;
        socket.emit("register-owner", currentCode);
    });

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ (GitHub Pages Support)
    document.getElementById("generateLinkBtn").onclick = () => {
        if(!currentCode) return showToast("Loading code...");
        
        const currentUrl = window.location.href;
        const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
        const link = `${baseUrl}/send.html?code=${currentCode}`;

        document.getElementById("clientLink").innerHTML =
            `<a href="${link}" target="_blank">${link}</a>`;
        showToast("Link Ready!");
    };

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯
    socket.on("existing-media", list => {
        const g = document.getElementById("gallery");
        g.innerHTML = list.length ? "" : `<div class="no-files">No files in cloud</div>`;
        list.forEach(addMediaToUI);
    });

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…ÙŠØ¯ÙŠØ§ Ø¬Ø¯ÙŠØ¯Ø© ÙÙˆØ± Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§
    socket.on("new-media", addMediaToUI);

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£Ù…Ø± Ø­Ø°Ù Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±
    socket.on("delete-media", (id) => {
        const el = document.querySelector(`.media-item[data-id="${id}"]`);
        if(el) el.remove();
        checkEmptyGallery();
    });

    function addMediaToUI(data) {
        const gallery = document.getElementById("gallery");
        gallery.querySelector(".no-files")?.remove();

        const div = document.createElement("div");
        div.className = "media-item";
        div.dataset.id = data.id;

        let preview = data.type === "image" 
            ? `<img src="${data.data}">` 
            : `<video src="${data.data}" controls></video>`;

        div.innerHTML = `
            <div class="media-container">${preview}</div>
            <div class="media-footer">
                <div class="actions">
                    <a class="download-btn" href="${data.data}" download="${data.name || 'file'}">â¬‡ Download</a>
                    <button class="delete-btn">ðŸ—‘ Delete</button>
                </div>
            </div>
        `;

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Firebase + Backend + UI)
        div.querySelector(".delete-btn").onclick = () => {
            const modal = document.getElementById("confirmModal");
            modal.style.display = "flex";

            document.getElementById("modalConfirm").onclick = async () => {
                try {
                    // 1. Ø§Ù„Ø­Ø°Ù Ù…Ù† Firebase
                    await deleteDoc(doc(db, "media", data.id));

                    // 2. Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ (Socket)
                    socket.emit("delete-media-request", { 
                        brandCode: Number(currentCode), 
                        id: data.id 
                    });

                    // 3. Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„ØµÙØ­Ø©
                    div.remove();
                    modal.style.display = "none";
                    showToast("Permanently Deleted");
                    checkEmptyGallery();
                } catch (err) {
                    showToast("Error deleting file");
                }
            };

            document.getElementById("modalCancel").onclick = () => {
                modal.style.display = "none";
            };
        };

        gallery.prepend(div);
    }

    function checkEmptyGallery() {
        const gallery = document.getElementById("gallery");
        if (gallery.children.length === 0) {
            gallery.innerHTML = `<div class="no-files">No files yet</div>`;
        }
    }
</script>

</body>
</html>